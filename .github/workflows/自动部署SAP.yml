name: éƒ¨ç½² SAP åº”ç”¨

on:
  workflow_dispatch:
    inputs:
      type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'wsç›´è¿'
        type: choice
        options:
          - wsç›´è¿
          - wssä¸­è½¬
      region:
        description: 'éƒ¨ç½²åŒºåŸŸ'
        required: true
        default: 'US(free)'
        type: choice
        options:
          - SG(free)
          - US(free)
          - AWS-AU(Sydney)
          - AWS-BR(SÃ£o Paulo)
          - AWS-CA(Toronto)
          - AWS-JP(Tokyo)
          - AWS-US(Virginia)
          - Azure-HK
          - Azure-US(Virginia)
          - Azure-DE(Frankfurt)
          - GCP-US(Lowa)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®åº”ç”¨å
        run: |
          RANDOM_STR=$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 6 | head -n 1)
          TYPE_SLUG=$(echo "${{ github.event.inputs.type }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          REGION_SLUG=$(echo "${{ github.event.inputs.region }}" | tr -d '() ' | tr '[:upper:]' '[:lower:]')
          echo "APP_NAME=${TYPE_SLUG}-${REGION_SLUG}-${RANDOM_STR}" >> $GITHUB_ENV
          echo "ç”Ÿæˆçš„åº”ç”¨å: ${TYPE_SLUG}-${REGION_SLUG}-${RANDOM_STR}"

      - name: é…ç½® CF API åœ°å€
        run: |
          declare -A CF_APIS=(
            ["SG(free)"]="https://api.cf.ap21.hana.ondemand.com"
            ["US(free)"]="https://api.cf.us10-001.hana.ondemand.com"
            ["AWS-AU(Sydney)"]="https://api.cf.ap10.hana.ondemand.com"
            ["AWS-BR(SÃ£o Paulo)"]="https://api.cf.br10.hana.ondemand.com"
            ["AWS-CA(Toronto)"]="https://api.cf.ca10.hana.ondemand.com"
            ["AWS-JP(Tokyo)"]="https://api.cf.jp10.hana.ondemand.com"
            ["AWS-US(Virginia)"]="https://api.cf.us10.hana.ondemand.com"
            ["Azure-HK"]="https://api.cf.hk10.hana.ondemand.com"
            ["Azure-US(Virginia)"]="https://api.cf.us20.hana.ondemand.com"
            ["Azure-DE(Frankfurt)"]="https://api.cf.eu20.hana.ondemand.com"
            ["GCP-US(Lowa)"]="https://api.cf.us30.hana.ondemand.com"
          )

          REGION="${{ github.event.inputs.region }}"
          CF_API="${CF_APIS[$REGION]}"

          if [ -z "$CF_API" ]; then
            echo "âŒ æœªè¯†åˆ«çš„åŒºåŸŸ: $REGION"
            exit 1
          fi

          echo "CF_API=$CF_API" >> $GITHUB_ENV
          echo "ç›®æ ‡ CF API: $CF_API"

      - name: å®‰è£… CF CLI
        run: |
          wget -q -O cf.deb https://packages.cloudfoundry.org/stable?release=debian64&version=v7&source=github
          sudo dpkg -i cf.deb

      - name: ç™»å½• CF
        run: |
          cf login -a ${{ env.CF_API }} \
            -u "${{ secrets.EMAIL }}" \
            -p "${{ secrets.PASSWORD }}" \
            --skip-ssl-validation
          ORG=$(cf orgs | awk 'NR>3 {print $1; exit}')
          SPACE=$(cf spaces | awk 'NR>3 {print $1; exit}')
          cf target -o "$ORG" -s "$SPACE"

      - name: éƒ¨ç½²åº”ç”¨
        run: |
          set -e
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åº”ç”¨: ${{ env.APP_NAME }}"
          if ! cf push ${{ env.APP_NAME }} \
            --docker-image ${{ env.DOCKER_IMAGE }} \
            -m ${{ env.MEMORY }} -k 256M --health-check-type port --no-start; then

            echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œæ­£åœ¨æ”¶é›†æ—¥å¿—..."
            cf logs ${{ env.APP_NAME }} --recent || true

            if cf logs ${{ env.APP_NAME }} --recent | grep -qi "insufficient resources"; then
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šå½“å‰åŒºåŸŸèµ„æºä¸è¶³ï¼Œå¯ä»¥å°è¯•æ¢ä¸ªåŒºåŸŸï¼Œæˆ–åœ¨æ—©ä¸Š 8:20~9:00 å†éƒ¨ç½²ã€‚"
            elif cf logs ${{ env.APP_NAME }} --recent | grep -qi "out of memory"; then
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šå†…å­˜ä¸è¶³ï¼Œè¯·å°è¯•æé«˜å†…å­˜ï¼ˆä¾‹å¦‚ -m 512M -k 512Mï¼‰ã€‚"
            elif cf logs ${{ env.APP_NAME }} --recent | grep -qi "image"; then
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šDocker é•œåƒæ‹‰å–é”™è¯¯ï¼Œè¯·æ£€æŸ¥é•œåƒåœ°å€æ˜¯å¦æ­£ç¡®ã€å¯è®¿é—®ã€‚"
            elif cf logs ${{ env.APP_NAME }} --recent | grep -qi "crash"; then
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šåº”ç”¨å¯åŠ¨åå´©æºƒï¼Œè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡æˆ–å¯åŠ¨å‘½ä»¤ã€‚"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šæœªçŸ¥åŸå› ï¼Œå¯èƒ½æ˜¯åŒºåŸŸèµ„æºä¸è¶³ã€‚"
            fi

            cf delete ${{ env.APP_NAME }} -f
            exit 1
          fi

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          cf set-env ${{ env.APP_NAME }} NAME "SAP"
          cf set-env ${{ env.APP_NAME }} UUID "${{ secrets.UUID }}"
          cf set-env ${{ env.APP_NAME }} NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env ${{ env.APP_NAME }} NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env ${{ env.APP_NAME }} NEZHA_KEY "${{ secrets.NEZHA_KEY }}"

      - name: å¯åŠ¨åº”ç”¨
        run: |
          cf start ${{ env.APP_NAME }}
          cf restage ${{ env.APP_NAME }}
          echo "âœ… åº”ç”¨å·²å¯åŠ¨å¹¶å®Œæˆ restage"

      - name: éªŒè¯åº”ç”¨çŠ¶æ€
        run: |
          cf apps | grep ${{ env.APP_NAME }}

      - name: è¾“å‡ºåº”ç”¨ä¿¡æ¯
        run: |
          APP_URL="https://$(cf app ${{ env.APP_NAME }} | grep routes: | awk '{print $2}')"
          echo "::notice::ğŸš€ éƒ¨ç½²å®Œæˆ: åº”ç”¨ ${{ env.APP_NAME }}"
          echo "::notice::ğŸŒ è®¿é—®åœ°å€: $APP_URL"
          echo "::notice::ğŸ“ åŒºåŸŸ: ${{ github.event.inputs.region }}"
          echo "::notice::ğŸ”– éƒ¨ç½²ç±»å‹: ${{ github.event.inputs.type }}"
